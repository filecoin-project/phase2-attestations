# Filecoin Trusted-Setup #2

## Hardware Requirements

| Circuit | Initial Param-Gen | Contributing | Contribution Verification | 
| :-----: | :------: | :------: | :------: |
| Empty-Sector-Update 32GiB and 64GiB | 155GiB RAM, 125GiB disk, 2h runtime (64 cores) | 8GiB RAM, 40GiB Disk, 30min runtime (64 cores) | 40GiB RAM, 40GiB Disk, 1h runtime (64 cores) |
| Empty-Sector-Update-Poseidon 32GiB and 64GiB | **TODO** RAM, **TODO** disk, 1h10min runtime (64 cores) | **TODO** RAM, **TODO** Disk, 10min runtime (64 cores) | **TODO** RAM, **TODO** Disk, 10min runtime (64 cores) |

## Participant Instructions

Before their time window, each participant will receive a download and upload URL where they will download the previous participant's contribution and upload their own contribution.

Each participant must have an SSH keypair which they can use to `rsync` files to and from the trusted-setup coordinator. Each Participant must send the trusted-setup coordinator their SSH public-key.

Each participant must sign their contribution using GPG; the signing public-key must be kept in a
publicly accessible location, for example a GitHub Gist
([example](https://gist.githubusercontent.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a/raw/2f2623c4de38a17c1334e3da5972b5b64d70715f/pubkey.asc)). The trusted-setup coordinator will send each participant commands to either generate a single-use GPG signing keypair or to import a GPG signing key which was previously generated by the participant.

0. Install dependencies

On Ubuntu:

```
$ sudo apt update
$ sudo apt install -y curl git gpg b2sum rsync build-essential hwloc libhwloc-dev pkg-config libssl-dev ocl-icd-opencl-dev

# Install Rust via Rustup (https://www.rust-lang.org/tools/install)
$ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
> 1
$ source $HOME/.cargo/env
```

1. Build `phase2`
 
```
$ git clone https://github.com/filecoin-project/filecoin-phase2.git
$ cd filecoin-phase2
$ git checkout empty-sector-update
$ cargo build --release --bins && mv target/release/filecoin-phase2 phase2
# Check that the binary works using:
$ ./phase2 --help
```

2. Start a `tmux` session

Some trusted-setup commands take hours to finish; running those commands in a `tmux` session ensures that long-running processes will not be preemptively stopped, for example if your computer goes to sleep.

```
$ tmux new -s phase2
```

You can detach from the "phase2" session during long-running processes (specifically file downloading/uploading and running `phase2 contribute`) without stopping them using: `ctrl-b d`.

You can reattach to the "phase2" session using:

```
$ tmux a
```

3. Download the previous participant's contribution

```
$ rsync -vP --append <download url>
```

4. Verify checksums

```
$ b2sum -c b2sums
```

5. Make contribution(s)

You will run the following command for each circuit which you are contributing to.

Remember to smash your keyboard and then to press Enter/Return at the start of each contribution.

```
$ ./phase2 contribute <previous participant's contribution>
```

After successfully contributing you should see the log:

```
[INFO] successfully made contribution
```

you should also see files in the current directory which have names similar to:

```
update_poseidon_32gib_8413077_1_small
update_poseidon_32gib_8413077_1_small.contrib
update_poseidon_32gib_8413077_1_small.log
```

6. Compute checksum of contribution(s)

If you are contributing to multiple circuits, you must compute a checksum for each circuit's contribution.

```
$ b2sum <participant's contribution>
```

Send the computed checksum(s) to the trusted-setup coordinator, probably via Slack.

7. Sign files

Create a directory to store a termporary GPG keyring.

```
$ mkdir keyring
```

Either generate a single-use GPG signing keypair or import a previously generated GPG (private) signing key.
- Generate a new signing keypair:
```
$ gpg --homedir keyring --pinentry-mode loopback --passphrase '' --quick-generate-key "Filecoin trusted-setup #2" ed25519 default none
$ gpg --homedir keyring --armor --export-secret-key > keyring/seckey.asc
$ gpg --homedir keyring --armor --export > keyring/pubkey.asc
```
- Import a previously generated GPG signing key:
```
$ gpg --homedir keyring --import <private key>
```

Upload your GPG public-key to a publicly accessible location so that your signature(s) can be validated.

Sign your contribution files; run the following two commands for each circuit which you are contributing to:

```
$ gpg --homedir keyring --armor -o <filename>.sig --detach-sign <filename>
$ gpg --homedir keyring --armor -o <filename>.contrib.sig --detach-sign <filename>.contrib
```

8. Upload files

```
$ rsync -vP --append <participant's files> <upload url>
```

## Participant Public Keys

The following GPG keys are used to verify each participant's trusted-setup contribution.

| Participant Num. | Participant Name | Link to Key | Backup Copy of Key |
| :-----: | :------: | :------: | :-----: |
| 0 | Jake ([@drpetervannostrand](https://github.com/drpetervannostrand)) | [Gist](https://gist.github.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a) | [00_jake.asc](keys/00_jake.asc) |
| 1 | Jake ([@drpetervannostrand](https://github.com/drpetervannostrand)) | [Gist](https://gist.github.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a) | [01_jake.asc](keys/01_jake.asc) |
| 2 | Nemo ([@cryptonemo](https://github.com/cryptonemo)) | [Gist](https://gist.github.com/cryptonemo/c3e3a120199de6c015d09709a6ef03f5) | [02_nemo.asc](keys/02_nemo.asc) |
| 3 | Dig ([@dignifiedquire](https://github.com/dignifiedquire)) | [Gist](https://gist.github.com/dignifiedquire/a7a5a95bd3b43261c94024253a7b8482) | [03_dig.asc](keys/03_dig.asc) |
| 4 | Magik ([@magik6k](https://github.com/magik6k)) | [Gist](https://gist.github.com/magik6k/eb94516a2404f7aefd1e881deb866705) | [04_magik.asc](keys/04_magik.asc) |
| 5 | Why ([@whyrusleeping](https://github.com/whyrusleeping)) | [TODO](...) | [TODO](...) |
