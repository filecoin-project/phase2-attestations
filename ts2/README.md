# EmptySectorUpdate Trusted-Setup

Filecoin ran a trusted-setup during December-2021 and January-2022 to generate Groth16 parameters for four new Filecoin proofs: EmptySectorUpdate (also called SnapDeals) for 32GiB and 64GiB sector sizes. Note that this trusted-setup is distinct from Filecoin's Mainnet trusted-setup which generated Groth16 parameters for proofs: SDR-PoRep, Winning-PoSt, and Window-PoSt.

## Participant Attestation Files

Each participant in a circuit's trusted-setup downloads the previous participant's Groth16 parameters then runs the `phase2` program to contribute randomness to those parameters resulting in a new parameters file. Additionally, each contribution process writes a `.contrib` file which is used to validate the participant's contribution. Participants sign their Groth16 parameters and their `.contrib` file using GPG and publish their GPG public-key to a publicly accessible location. A backup of each participant's GPG public-key is also stored in this repo.

Each circuit's `.contrib ` files, participant signatures, and backup GPG public-keys are stored within this repo in the following folders:

| Circuit | Sector-Size | Contributions | Signatures | Signing Keys |
| :-----: | :---------: | :-----------: | :--------: | :----------: |
| EmptySectorUpdate | 32GiB | [`update-32/contribs`](update-32/contribs) | [`update-32/sigs`](update-32/sigs) | [`update-keys`](update-keys) |
| EmptySectorUpdate | 64GiB | [`update-64/contribs`](update-64/contribs) | [`update-64/sigs`](update-64/sigs) | [`update-keys`](update-keys) |
| EmptySectorUpdate-Poseidon | 32GiB | [`updatep-32/contribs`](updatep-32/contribs) | [`updatep-32/sigs`](updatep-32/sigs) | [`updatep-keys`](updatep-keys) |
| EmptySectorUpdate-Poseidon | 64GiB | [`updatep-64/contribs`](updatep-64/contribs) | [`updatep-64/sigs`](updatep-64/sigs) | [`updatep-keys`](updatep-keys) |

The file [`b2sums`](b2sums) stores the BLAKE2 digest of each file generated during these circuits' trusted-setups; this checksums file can be used to verify the integrity of files downloaded by participants or by parties validating Filecoin's trusted-setup.

## Hardware Requirements

Hardware requirements for participating in each circuit's trusted-setup are provided in the following table. Note that participants do not need to generate each circuit's initial phase2 parameters nor verify their own contributions (although they can if they would like). Each circuit's initial parameters are generated by the trusted-setup coordinator; similarly each participant's contributions are verified by the trusted-setup coordinator upon receiving them. Both initial parameter generation and contribution verification are deterministic and have significant hardware requirements, because of this Filecoin chooses to perform those actions rather than requiring participants to. All stages of the trusted-setup can be independently verified by parties outside of Filecoin.

| Circuit | Initial Param-Gen | Contributing | Contribution Verification | 
| :-----: | :------: | :------: | :------: |
| EmptySectorUpdate <br /> (32GiB and 64GiB) | RAM: 155GiB <br /> Disk: 125GiB <br /> Runtime: 2h | RAM: 1GiB <br /> Disk: 40GiB <br /> Runtime: 30min | RAM: 40GiB <br /> Disk: 40GiB <br /> Runtime: 1h |
| EmptySectorUpdate-Poseidon <br /> (32GiB and 64GiB) | RAM: 50GiB <br /> Disk: 35GiB <br /> Runtime: 1h10min | RAM: 1GiB <br /> Disk: 12GiB <br /> Runtime: 10min | RAM: 12GiB <br /> Disk: 12GiB <br /> Runtime: 10min |

- **Note:** the above runtimes were measured on a computer utilizing 64 CPUs, however 64 cores is not a hardware requirement. For all parts of phase2 (initial param-gen, contribution, verification) runtime is inversely correlated with the number of CPUs available, i.e. fewer cores result in a slower runtimes, whereas more cores result in faster runtimes.

### Participant File Sizes

The following table gives the size of each circuit's trusted-setup parameters file. Each participant is required to download one parameters file for each circuit they are contributing to, then to generate and upload a new parameters file for each circuit they are contributing to.

| Circuit | File Size |
| :-----: | :-------: |
| EmptySectorUpdate <br /> (32GiB and 64GiB) | 20GiB |
| EmptySectorUpdate-Poseidon <br /> (32GiB and 64GiB) | 5GiB |

### Initial Param-Gen and Full Trusted-Setup Verification

Generating initial parameters for each circuit is a deterministic process, i.e. a circuit's initial parameters are constant and do not change based upon who generates them or when they are generated.

The intial param-gen for large circuits requires significant computational resources; out of convenience Filecoin's trusted-setup coordinator generated each circuit's initial params.

In order to validate the full trusted-setup, a validator should generate their own copy of each circuit's initial parameters then compare digests of the independently generated initial parameters against those of the published initial parameters.

Before generating initial parameters for each circuit, a phase1.5 file corresponding to each circuit's size must be downloaded. These phase1.5 files were generated during phase1 of Filecoin's first trusted-setup.

| Circuit | Phase1.5 File | File Size
| :-----: | :------: | :------: |
| EmptySectorUpdate <br /> (32GiB and 64GiB) | [`phase1radix2m27`](https://trusted-setup.s3.amazonaws.com/challenge19/phase1radix2m27) | 72GiB |
| EmptySectorUpdate-Poseidon <br /> (32GiB and 64GiB) | [`phase1radix2m25`](https://trusted-setup.s3.amazonaws.com/challenge19/phase1radix2m25) | 18GiB |

## Participant Instructions

**Note:** the following commands were run on Ubuntu.

### Before Participating

#### 0.1. Send SSH Public-Key to Coordinator

Each participant must have an SSH keypair which they can use to download and upload files from the trusted-setup file server. Each Participant must send their SSH public-key to the trusted-setup coordinator.

If a participant does not have an SSH keypair, one can be generated by running the following command; note that the SSH private-key file is `~/ssh_key` and public-key file is `~/ssh_key.pub`:
```
$ ssh-keygen -t rsa -f ~/ssh_key -N '' -C ''
```

#### 0.2. Publish GPG Public-Key

Each participant must sign their contribution using GPG. Each participant's signing public-key must be stored in a publicly accessible location, [for example using a GitHub Gist](https://gist.github.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a#file-pubkey-asc).

Each participant may use either a preexisting GPG signing keypair, for example a keypair that was generated during Filecoin's Mainnet trusted-setup, or may generate a new signing keypair (which should be used exclusively for Filecoin's trusted-setup). 

If a participant does not already have a GPG signing keypair, one can be generated using the following command; note that the participant should update the `participant_name='...'` variable to contain their own name, handle, or pseudonym:
```
$ participant_name='...'; \
      mkdir keyring \
      && gpg --homedir keyring --pinentry-mode loopback --passphrase '' --quick-generate-key "Filecoin trusted-setup esu ${participant_name}" ed25519 default none \
      && gpg --homedir keyring --armor --export > sig_pubkey.asc \
      && gpg --homedir keyring --armor --export-secret-key > sig_seckey.asc \
      && rm -rf keyring
```
In the above command, the file `sig_seckey.asc` is the signing private-key and the file `sig_pubkey.asc` is the signing public-key; the public-key should be copied to a public location.

#### 0.3. Install Dependencies and Build `phase2`

Check for missing dependencies:
```
$ if ! command -v curl >/dev/null 2>&1; then echo 'missing: curl'; fi; \
      if ! command -v git >/dev/null 2>&1; then echo 'missing: git'; fi; \
      if ! command -v gpg >/dev/null 2>&1; then echo 'missing: gpg'; fi; \
      if ! command -v b2sum >/dev/null 2>&1; then echo 'missing: b2sum'; fi; \
      if ! command -v rsync >/dev/null 2>&1; then echo 'missing: rsync'; fi; \
      if ! command -v pkg-config >/dev/null 2>&1; then echo 'missing: pkg-config'; fi; \
      if ! command -v rustup >/dev/null 2>&1; then echo 'missing: rustup'; fi; \
      if ! dpkg -s build-essential >/dev/null 2>&1; then echo 'missing: build-essential'; fi; \
      if ! dpkg -s hwloc >/dev/null 2>&1; then echo 'missing: hwloc'; fi; \
      if ! dpkg -s libhwloc-dev >/dev/null 2>&1; then echo 'missing: libhwloc-dev'; fi; \
      if ! dpkg -s libssl-dev >/dev/null 2>&1; then echo 'missing: libssl-dev'; fi; \
      if ! dpkg -s ocl-icd-opencl-dev >/dev/null 2>&1; then echo 'missing: ocl-icd-opencl-dev'; fi
```

Install missing dependencies; note that the following does not reinstall or upgrade dependencies which already exist:
```
$ sudo apt update
$ sudo apt install --no-upgrade curl git gpg b2sum rsync build-essential hwloc libhwloc-dev pkg-config libssl-dev ocl-icd-opencl-dev
```

If it's not already installed, install Rust via Rustup:
```
# Installation instructions were copied from Rustup's website: https://www.rust-lang.org/tools/install
$ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
> 1
$ source $HOME/.cargo/env
```

Build `phase2`:
```
$ git clone https://github.com/filecoin-project/filecoin-phase2.git
$ cd filecoin-phase2
$ git checkout empty-sector-update
$ cargo build --release --bins && mv target/release/filecoin-phase2 phase2
```

Check that the `phase2` binary works:
```
$ ./phase2 --help
```

### Example Participant Instructions

At the start of their timeslot, each participant will be sent exact instructions on how to run the trusted-setup; the following commands are meant to serve only as an example of what participants will run during their trusted-setup timeslot.

#### 1. Receive Access to the Trusted-Setup File Server

At the start of their timeslot each participant will be given commands to download and upload files to Filecoin's trusted-setup file server.

#### 2. Start a `tmux` Session

Some trusted-setup commands take hours to finish; running those commands in a `tmux` session ensures that long-running processes will not be preemptively stopped, for example if your computer goes to sleep.

```
$ tmux new -s phase2
```

- You can detach from the `tmux` session during long-running processes (specifically file downloading/uploading and running when `phase2 contribute`) without stopping those processes by pressing the keys: `ctrl+b d`.
- You can reattach to the `tmux` session by running: `$ tmux a -t phase2`.

#### 3. Download the Previous Participant's Parameters

Each participant will be given a `download url` where they can download the previous participant's parameters.

```
$ rsync -vP --append -e 'ssh -i <path to SSH private-key>' <download url> .
```

#### 4. Verify Checksums of Downloaded Files

The participant will either download a checksums file `b2sums` from our [GitHub repo](https://raw.githubusercontent.com/filecoin-project/phase2-attestations/trusted-setup-2/ts2/b2sums), trusted-setup file server, or will be sent to the participant by the trusted-setup coordinator.

The participant should run the following command to ensure the integrity of their downloaded files:
```
$ grep -E '<downloaded file 1>|<downloaded file 2>' b2sums | b2sum -c
```
which will output the following if the file digests are correct.
```
<downloaded file 1>: OK
<downloaded file 2>: OK
```

#### 5. Make Contribution

Remember to randomly press keyboard keys after running `./phase2 contribute`; when finished randomly pressing keys press `Enter`/`Return`.

```
$ ./phase2 contribute <previous participant's parameters>
```

After successfully contributing you should see the log:

```
[INFO] successfully made contribution
```

You should also see files in the current directory which have names similar to:

```
update_poseidon_32gib_8413077_1_small
update_poseidon_32gib_8413077_1_small.contrib
update_poseidon_32gib_8413077_1_small.log
```

#### 6. Compute Checksums

Hash the parameters file written by `./phase2 contribute`; note that this file has no file extension (e.g. `.contrib` or `.log`).

```
$ b2sum <parameters file>
```

Send the computed checksum to the trusted-setup coordinator (probably via Slack).

#### 7. Sign Files

Create a directory to store a termporary GPG keyring.

```
$ mkdir keyring && chmod 700 keyring
```

Either import a previously generated GPG signing key (i.e. private-key) or generate a single-use GPG signing keypair:
- Option 1) Import a previously generated GPG signing key:

```
$ gpg --homedir keyring --import <path to private key file>
```
- Option 2) Generate a new signing keypair: note that the participant should update the `participant_name='...'` variable with their name, handle, or pseudonym:
```
$ participant_name='...'; \
      gpg --homedir keyring --pinentry-mode loopback --passphrase '' --quick-generate-key "Filecoin trusted-setup esu ${participant_name}" ed25519 default none \
      && gpg --homedir keyring --armor --export > keyring/pubkey.asc \
      && gpg --homedir keyring --armor --export-secret-key > keyring/seckey.asc
```

Remember to upload your GPG public-key to a publicly accessible location so that your signature can be validated.

Send the trusted-setup coordinator a link to the signing public-key.

Sign your contribution files using:

```
$ gpg --homedir keyring --armor -o <params>.sig --detach-sign <params> \
    && gpg --homedir keyring --armor -o <params>.contrib.sig --detach-sign <params>.contrib
```

#### 8. Upload Files

The trusted-setup coordinator will give each participant an `upload_url` which can be used to upload files to the trusted-setup file server.

```
$ rsync -vP --append -e 'ssh -i <path to SSH private-key>' <files> <upload url>
```

## Participant Signing Keys

Each trusted-setup participant is required to sign their contribution using GPG and to publish their signing public-key to a publicly accessible location. The following public-keys can be used to verify each participant's signature.

### EmptySectorUpdate Circuits (32GiB and 64GiB)

| Participant Num. | Participant Name | Link to Key | Backup Copy of Key |
| :-----: | :------: | :------: | :-----: |
| 0 | Jake ([@drpetervannostrand](https://github.com/drpetervannostrand)) | [Gist](https://gist.github.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a) | [00_jake.asc](update-keys/00_jake.asc) |
| 1 | Jake ([@drpetervannostrand](https://github.com/drpetervannostrand)) | [Gist](https://gist.github.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a) | [01_jake.asc](update-keys/01_jake.asc) |
| 2 | Nemo ([@cryptonemo](https://github.com/cryptonemo)) | [Gist](https://gist.github.com/cryptonemo/c3e3a120199de6c015d09709a6ef03f5) | [02_nemo.asc](update-keys/02_nemo.asc) |
| 3 | Dig ([@dignifiedquire](https://github.com/dignifiedquire)) | [Gist](https://gist.github.com/dignifiedquire/a7a5a95bd3b43261c94024253a7b8482) | [03_dig.asc](update-keys/03_dig.asc) |
| 4 | Magik ([@magik6k](https://github.com/magik6k)) | [Gist](https://gist.github.com/magik6k/eb94516a2404f7aefd1e881deb866705) | [04_magik.asc](update-keys/04_magik.asc) |
| 5 | Why ([@whyrusleeping](https://github.com/whyrusleeping)) | [Gist](https://gist.github.com/whyrusleeping/f6d21d8968107d2b61676bdb154095fc) | [05_why.asc](update-keys/05_why.asc) |
| 6 | Grandhelmsman ([@IPFS-grandhelmsman](https://github.com/IPFS-grandhelmsman)) | [Gist](https://gist.github.com/IPFS-grandhelmsman/be1a3cc62d43da2e70d089c1c491fdd7) | [06_grandhelmsman.asc](update-keys/06_grandhelmsman.asc) |
| 7 | IPFS-Force ([@force_ipfs](https://twitter.com/force_ipfs)) | [Gist](https://gist.github.com/leone-Y/080a7c8c3c479d249de35eeadd6081a4) | [07_ipfs_force.asc](update-keys/07_ipfs_force.asc) |

### EmptySectorUpdate-Poseidon Circuits (32GiB and 64GiB)

| Participant Num. | Participant Name | Link to Key | Backup Copy of Key |
| :-----: | :------: | :------: | :-----: |
| 0 | Jake ([@drpetervannostrand](https://github.com/drpetervannostrand)) | [Gist](https://gist.github.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a) | [00_jake.asc](updatep-keys/00_jake.asc) |
| 1 | Jake ([@drpetervannostrand](https://github.com/drpetervannostrand)) | [Gist](https://gist.github.com/DrPeterVanNostrand/94c7cc9cfc80dee29f99d97b7cc4f68a) | [01_jake.asc](updatep-keys/01_jake.asc) |
| 2 | Nemo ([@cryptonemo](https://github.com/cryptonemo)) | [Gist](https://gist.github.com/cryptonemo/c3e3a120199de6c015d09709a6ef03f5) | [02_nemo.asc](updatep-keys/02_nemo.asc) |
| 3 | Grandhelmsman ([@IPFS-grandhelmsman](https://github.com/IPFS-grandhelmsman)) | [Gist](https://gist.github.com/IPFS-grandhelmsman/be1a3cc62d43da2e70d089c1c491fdd7) | [03_grandhelmsman.asc](updatep-keys/03_grandhelmsman.asc) |
| 4 | IPFS-Force ([@force_ipfs](https://twitter.com/force_ipfs)) | [Gist](https://gist.github.com/leone-Y/080a7c8c3c479d249de35eeadd6081a4) | [04_ipfs_force.asc](updatep-keys/04_ipfs_force.asc) |
